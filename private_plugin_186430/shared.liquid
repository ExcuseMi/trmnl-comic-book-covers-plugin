{% liquid
# Get plugin settings
assign display_style = trmnl.plugin_settings.custom_fields_values.display_style | default: "full|cover|landscape|3"
assign display_style_parts = display_style | split: "|"
assign display_mode = display_style_parts[1]
assign screen = display_style_parts[0]
assign show_background = trmnl.plugin_settings.custom_fields_values.show_background | default: "yes"
assign layout_orientation = display_style_parts[2]
assign max_comics = display_style_parts[3] | plus: 0

# Load comic data
assign comics = "" | split: "" 

# Loop over IDX_ variables until nothing is found
for i in (0..5)
assign idx_name = "IDX_" | append: i
assign idx_data = [idx_name]

if idx_data and idx_data.results
assign comics = comics | concat: idx_data.results
endif

# Break early if we've reached the max_comics limit
if comics.size >= max_comics
break
endif
endfor

# Apply limit after concatenation to ensure we don't exceed max_comics
assign comics = comics | limit: max_comics | sort: "cover_date"
assign comics_count = comics.size
%}
<style>
  .full-width-label {
    display: block; width: 100%
  }
  .comic-bg {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; object-position: center; opacity: 0.2; filter: blur(8px) brightness(1.3); z-index: 0;
  }
  .comic-column {
    align-items: center;
  }
  .comic-image {
    border: 1px solid #000;
  }
  .no-gap {
    gap: 0;
  }
.comic-grid-container {
  {% if layout_orientation == "portrait" %}
    {% if screen == "vertical" %}
      height: fit-content;
    {% elsif screen == "full" or screen == "quadrant" or screen == "horizontal" %}
      width: 80%;
    {% else %}
      width: fit-content;
    {% endif %}
  {% elsif layout_orientation == "landscape" %}
     {% if screen == "vertical" %}
      width: 70%;

      {% else %}
    width: fit-content;
  {% endif %}
  {% endif %}
  margin: 0 auto;
}
</style>
{% comment %} Grid Mode - Multiple Covers with Background {% endcomment %}
{% comment %} Pick random comic for background {% endcomment %}
{% assign random_index = timestamp | modulo: comics_count %}
{% assign random_comic = comics[random_index] %}
{% assign background_url = random_comic.image.screen_url | default: random_comic.image.medium_url | default: "" %}

{% comment %} Background Image - outside columns {% endcomment %}
{% if show_background == "yes" and background_url != "" %}
<img src="{{ background_url }}" class="image-dither image comic-bg"/>
{% endif %}

{% if comics_count == 0 %}
<div class="layout layout--center">
  <div class="title text--center">No Comics Found</div>
  <div class="description text--center">
    No comic covers found with your current filters. Try adjusting your filters or check your API key.
  </div>
</div>

{% else %}

<div class="layout layout--stretch">

  {% if display_mode == "details" and comics_count > 0 %}
  {% comment %} Full Details Mode - Single Comic with Info Panel {% endcomment %}
  {% assign comic = comics[0] %}
  {% assign name = comic.name | default: "" %}
  {% assign cover_date = comic.cover_date | default: "" %}
  {% assign issue_number = comic.issue_number | default: "" %}
  {% assign volume_name = comic.volume.name | default: "" %}
  {% assign image_url = comic.image.small_url | default: comic.image.original_url | default: "" %}
  {% assign api_detail_url = comic.api_detail_url | default: "" %}

  {% comment %} Build Comic Vine URL {% endcomment %}
  {% if api_detail_url != "" %}
  {% assign url_parts = api_detail_url | split: "/" %}
  {% assign issue_id = url_parts[5] | default: "" %}

  {% if issue_id != "" %}
  {% assign comic_vine_url = "https://comicvine.gamespot.com/issues/" | append: issue_id %}
  {% else %}
  {% assign comic_vine_url = comic.site_detail_url | default: "https://comicvine.gamespot.com/" %}
  {% endif %}
  {% else %}
  {% assign comic_vine_url = comic.site_detail_url | default: "https://comicvine.gamespot.com/" %}
  {% endif %}

  {% comment %} Format date {% endcomment %}
  {% if cover_date != "" %}
  {% assign date_parts = cover_date | split: "-" %}
  {% assign year = date_parts[0] %}
  {% assign formatted_date = year %}
  {% else %}
  {% assign formatted_date = "Unknown Date" %}
  {% endif %}

  {% comment %} Get additional details {% endcomment %}
  {% assign description = comic.description | default: "" %}

  {% assign character_names = "" | split: "" %}
  {% if comic.character_credits %}
  {% for character in comic.character_credits %}
  {% if character.name %}
  {% assign character_names = character_names | push: character.name %}
  {% endif %}
  {% endfor %}
  {% endif %}

  {% assign team_names = "" | split: "" %}
  {% if comic.team_credits %}
  {% for team in comic.team_credits %}
  {% if team.name %}
  {% assign team_names = team_names | push: team.name %}
  {% endif %}
  {% endfor %}
  {% endif %}

  {% assign people_names = "" | split: "" %}
  {% if comic.person_credits %}
  {% for person in comic.person_credits %}
  {% if person.name %}
  {% assign people_names = people_names | push: person.name %}
  {% endif %}
  {% endfor %}
  {% endif %}

  {% if description != "" %}
  {% assign description = description | strip_html | truncate: 200 %}
  {% endif %}
  <div class="flex gap--m">
    <!-- Cover Image -->
    <div class="flex--grow-2" > 
      <img src="{{ image_url }}" class="image image-dither image--contain comic-image h--full" />
    </div>
    <!-- Details Panel -->
    <div class="flex--grow-1" style="display: flex; align-items: center; min-height: 0;">
      <div style="width: 100%;">
        <div class="title text--large mb--s" data-clamp="2">{{ name }}</div>
        <div class="description text--small mb--xs">{{ volume_name }}</div>
        <div class="flex gap--xs mb--m">
          {% if issue_number != "" %}
          <span class="label label--outlined">#{{ issue_number }}</span>
          {% endif %}
          <span class="label">{{ formatted_date }}</span>
        </div>

        <!-- Description -->
        <div class="mb--m pb--m border--b">
          <div class="label text--xs text--upper mb--xs">Synopsis</div>
          <div class="description text--xs">
            {% if description != "" %}
            {{ description }}
            {% else %}
            No synopsis available.
            {% endif %}
          </div>
        </div>

        <!-- Characters -->
        {% if character_names.size > 0 %}
        <div class="mb--m pb--m border--b">
          <div class="label text--xs text--upper mb--xs">Characters</div>
          <div class="flex flex--wrap gap--xs">
            {% for character in character_names limit: 8 %}
            <span class="label label--outlined text--xs px--s py--xs">{{ character }}</span>
            {% endfor %}
            {% if character_names.size > 8 %}
            <span class="label label--inverted text--xs px--s py--xs">+{{ character_names.size | minus: 8 }}</span>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Teams -->
        {% if team_names.size > 0 %}
        <div class="mb--m pb--m border--b">
          <div class="label text--xs text--upper mb--xs">Teams</div>
          <div class="flex flex--wrap gap--xs">
            {% for team in team_names limit: 4 %}
            <span class="label label--outlined text--xs px--s py--xs">{{ team }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Creators -->
        {% if people_names.size > 0 %}
        <div class="mb--s">
          <div class="label text--xs text--upper mb--xs">Creators</div>
          <div class="flex flex--wrap gap--xs">
            {% for person in people_names limit: 6 %}
            <span class="label label--outlined text--xs px--s py--xs">{{ person }}</span>
            {% endfor %}
            {% if people_names.size > 6 %}
            <span class="label label--inverted text--xs px--s py--xs">+{{ people_names.size | minus: 6 }}</span>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  {% else %}

  <div class="columns h--full">
    {% for comic in comics %}
    {% assign image_url = comic.image.small_url | default: comic.image.original_url | default: "" %}
    {% assign index = forloop.index0 %}
    {% assign is_even = index | modulo: 2 %}

    {% if image_url != "" %}
    <div class="column h--full">
      <div class="grid w--auto comic-grid-container h--full flex--center-y">
        <div class="col col--center h--full flex flex--col flex--center-y no-gap">
          {% if is_even == 0 %}
          <div class="label text--xs label--inverted w--full"  {% if screen == "vertical" or  screen=="horizontal" or screen = "quadrant" %} data-clamp="2" {% endif %} >#{{ comic.issue_number }} {% if screen != "quadrant" and comic.name %}{{ comic.name | upcase }}{% endif %}</div>
          <img src="{{ image_url }}" class="image image-dither comic-image w--full" >
          {% else %}
          <img src="{{ image_url }}" class="image image-dither comic-image w--full" />
          <div class="label text--xs label--inverted w--full"  {% if screen == "vertical" or  screen=="horizontal" or screen = "quadrant" %} data-clamp="2" {% endif %} >#{{ comic.issue_number }} {% if screen != "quadrant" and comic.name %}{{  comic.name | upcase }}{% endif %}</div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
    {% endfor %}
  </div>


  {% endif %}
</div>

{% endif %}